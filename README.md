## Order management service

---

#### Бэкенд для сервиса управления заказами

---

Для реализации использованы:

Python 3.13.4

FastApi - для создания api интерфейса сервиса.

Asyncpg - интеграция с базой данных PostgreSQL.

SQLAlchemy - ORM система для работы с базой данных.

Alembic - инструмент для работы с миграциями для SQLAlchemy.

Redis - NoSQL база данных.

Kafka - брокер сообщений.

Celery - система очередей фоновых задач.

---

### Подготовка к запуску

1. Создать файл .env, заполнить его значениями из .env.example.
2. Заполнить значения для конфигурационных параметров окружения в файле .env
3. Файл .env должен располагаться в той же директории, что и файл .env.example.

> При запуске проекта в docker compose, переменные `POSTGRES_HOST`, `REDIS_HOST` и `KAFKA_HOST` должны 
> указывать на названия соответствующих docker контейнеров. В файле .env.example значения уже указывают 
> на названия нужных контейнеров.

> Для защиты эндпоинтов используется JWT-аутентификация. Перед запуском проекта, для параметра SECRET_KEY в .env 
> указать секретный ключ. Сгенерировать секретный ключ можно воспользовавшись сервисом - [jwtsecrets](https://jwtsecrets.com/#generator).

---

### Запуск локально/вручную

1. Установить Python 3.13.4 в операционную систему.
2. Установить uv пакетный менеджер: `pip install uv`.

   Если возникнут ошибки использовать команды -

   - в unix системе - `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - в windows системе - `powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"`

3. Находясь в папке с проектом, создать виртуальное окружение командой `uv venv .venv`.
4. Находясь в папке с проектом, активировать виртуальное окружение:
   - для Windows системы, используя команду `.venv\Scripts\activate`
   - для Unix системы, используя команду `source .venv/bin/activate`
5. Установить необходимые зависимости используя команду `uv pip install -r pyproject.toml`.
6. Запустить проект одной из команд на выбор:
   - запуск проекта напрямую - `python main.py`
   - запуск проекта в windows cmd с перезапуском при обновлении файлов -
     ```commandline
      set PYTHONPATH=src
      uvicorn main:app --port=8008 --reload
     ```
   - запуск проекта в windows PowerShell с перезапуском при обновлении файлов -
     ```commandline
     $env:PYTHONPATH = "src"
     uvicorn main:app --port=8008 --reload
     ```
   - запуск проекта в unix с перезапуском при обновлении файлов -
     ```commandline
     PYTHONPATH=src uvicorn main:app --port=8008 --reload
     ```
   - запуск проекта в unix c использованием makefile и с перезапуском при обновлении файлов -
     ```commandline
     make local.run
     ```

---

### Запуск через Docker-Compose:

- Находясь в папке с проектом запустить сервис командой `docker compose --env-file .env -f "docker/dev/main.yml" up -d`
- В unix операционной системе возможно использование инструмента запуска make. Команды описаны в Makefile.

---

### Работа с миграциями Alembic для SQLAlchemy

* Создание миграций - `alembic revision --autogenerate -m "message"`
* Применение миграций - `alembic upgrade head`
* Откатиться на одну миграцию назад - `alembic downgrade -1`

В случае запуска проекта в docker compose, миграции применяются автоматически при старте проекта.
За применение миграций отвечает docker контейнер db.pg.migrate.

В случае локального запуска, для применения миграций, должны быть установленны зависимости проекта.
Это можно сделать следуя пунктам 1 - 4 из раздела [**Запуск локально/вручную**](#запуск-локальновручную) данного readme.
Таким образом, перед применением миграций для базы данных должно быть активировано виртуальное окружение.

Файлы миграций находятся в директории `/migrations`

---

### Перечень запускаемых в docker compose контейнеров:

```no-highlight
db.pg.server - база данных PostgreSQL версии 17. Используется как основное реляционное хранилище данных. 
По-умолчанию запускатеся на порте 5426.
db.pg.ui - web gui Pgweb, для доступа к таблицам PosttgreSQL из браузера. По-умолчанию запускатеся на порте 8081.
db.redis.server - NoSQL база данных Redis. Используется для кеширования запросов к API, 
как хранилище данных для fastapi-limiter и как брокер для Celery. По-умолчанию запускатеся на порте 6379.
db.pg.migrate - Контейнер для применения миграций Alembic для Postgresql. При запуске, при необходимости применяет миграции, затем останавливается.
kafka - брокер сообщений Kafka. По-умолчанию запускатеся на порте 9092 и транслирует порты 9092 и 9093.
kafka-ui - web gui для Kafka. Позволяет просматривать топики и сообщения в них. По-умолчанию запускатеся на порте 7777.
api.server - Основное FastApi приложение сервиса обработки заказов. По-умолчанию запускатеся на порте 8010.
api.worker - Celery worker. Выполняет фоновую обработку заказов полученных через Celery.
flower - web gui для Celery. Позволяет просматривать задачи выполняемые через Celery. По-умолчанию запускатеся на порте 5577.
```

---

### Перечень ссылок доступных через web:

* Swagger - http://127.0.0.1:8010/docs#/
* API основного приложения - http://127.0.0.1:8010/api/{...}
* WEB GUI Pgweb -  http://localhost:8081/
* WEB GUI Kafka - http://localhost:7777/
* WEB GUI Celery - http://localhost:5577/

---

### Перечень используемых в проекте python библиотек:

```no-highlight
fastapi==0.124.4 - Веб-фреймворк для создания API на Python.
uvicorn==0.38.0 - ASGI-сервер для запуска FastAPI и других асинхронных приложений.
sqlalchemy==2.0.45 - ORM система для работы с базами данных на Python.
alembic==1.17.2 - Инструмент для управления миграциями базы данных при работе с SQLAlchemy.
asyncpg==0.31.0 - Асинхронный драйвер для работы с PostgreSQL, оптимизированный под asyncio.
psycopg2-binary==2.9.11 - Синхронный драйвер PostgreSQL для Python в виде готового бинарного пакета.
passlib[bcrypt]==1.7.4 - Библиотека для безопасного хеширования и проверки паролей с поддержкой bcrypt.
bcrypt<4.0 - Криптографическая библиотека для хеширования паролей, закреплённая по версии для совместимости.
python-jose==3.5.0 - Реализация JWT, JWS и JWE для аутентификации и авторизации.
pydantic[email]==2.12.5 - Библиотека для валидации и сериализации данных с поддержкой проверки email-адресов.
pydantic-settings==2.12.0 - Расширение Pydantic для работы с настройками приложения через переменные окружения.
python-multipart==0.0.21 - Библиотека для обработки multipart/form-data (загрузка файлов и форм).
redis[asyncio]==7.1.0 - Асинхронный клиент Redis с поддержкой asyncio.
fastapi-limiter==0.1.6 - Middleware для ограничения частоты запросов (rate limiting) в FastAPI с использованием Redis.
aiokafka==0.12.0 - Асинхронный клиент Kafka для работы с продюсерами и консьюмерами.
celery==5.6.0 - Распределённая очередь задач для выполнения фоновых и отложенных задач.

```

---